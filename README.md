# 家庭能源管理系统 (HEMS) - 强化学习项目

## 项目概述

这是一个基于强化学习的家庭能源管理系统，旨在优化家庭用电成本、提高能源利用效率，并满足用户舒适度需求。系统集成了电动汽车充电、储能电池管理、洗衣机调度、空调控制和热水器管理等功能。

## 项目架构

### 核心组件

1. **环境模块** (`environment.py`)
   - 家庭能源管理环境模拟器
   - 包含所有设备的物理模型和状态转换逻辑
   - 提供奖励计算和约束处理

2. **强化学习算法** (`model/`目录)
   - PPO (Proximal Policy Optimization) - 主要算法
   - SAC (Soft Actor-Critic)
   - TD3 (Twin Delayed DDPG)
   - DQN (Deep Q-Network)

3. **数据处理** (`data/`目录)
   - 历史用电数据
   - 光伏发电数据
   - 电价数据

4. **可视化工具** (`plt.py`)
   - 训练过程可视化
   - 结果分析和图表生成

## 设备模型

### 1. 电动汽车 (EV)
- **容量**: 24 kWh
- **充放电功率**: -6.6 到 6.6 kW
- **效率**: 95%
- **约束**: 离家时最低电量要求

### 2. 储能电池 (ESS)
- **容量**: 24 kWh
- **充放电功率**: -4.4 到 4.4 kW
- **效率**: 95%
- **SOC约束**: 10% - 90%

### 3. 洗衣机
- **功率**: 1.5 kW
- **运行时长**: 1小时
- **调度选项**: 0-6 (不同时间段)

### 4. 空调系统
- **功率范围**: 0-5 kW
- **温度设定**: 16-30°C
- **舒适度模型**: 基于用户偏好温度

### 5. 热水器 (EWH)
- **容量**: 100L
- **温度范围**: 30-100°C
- **功率**: 0-2 kW
- **用户用水模型**: 随机分布

## 状态空间

系统状态包含以下维度：
- 家庭用电负荷
- 光伏发电量
- ESS电池状态
- EV电池状态
- 时间索引
- 电价
- 室外温度
- 洗衣机状态
- 空调功率
- 热水器温度和功率

## 动作空间

### 离散动作
- **EV充放电功率**: [-6.6, -3.3, 0, 3.3, 6.6] kW
- **ESS充放电功率**: [-4.4, -2.2, 0, 2.2, 4.4] kW
- **洗衣机调度**: [0, 1, 2, 3, 4, 5, 6] (时间段)
- **空调设定温度**: [16, 18, 20, 22, 24, 26, 28, 30] °C
- **热水器设定温度**: [40, 45, 50, 55, 60, 65, 70] °C

## 奖励函数

### 主要组成部分
1. **能源成本**: 基于分时电价的用电成本
2. **约束惩罚**: 电池SOC、设备功率等约束违反惩罚
3. **用户满意度**: 温度舒适度、设备使用便利性
4. **能源效率**: 可再生能源利用率

### 奖励权重
- 能源成本权重: 0.5
- 用户满意度权重: 0.5
- 约束违反权重: 0.5
- 温度舒适度权重: 0.1

## 算法特性

### PPO算法改进
1. **状态归一化**: 使用RunningStats进行在线状态归一化
2. **动作掩码**: 基于物理约束的动态动作掩码
3. **多分支网络**: 为不同设备设计独立的动作分支
4. **自适应熵**: 动态调整探索策略
5. **约束处理**: 可选的约束优化机制

## 使用方法

### 环境要求
```bash
pip install torch numpy matplotlib scipy pandas openpyxl
```

### 运行训练
```python
# 运行PPO训练
python model/PPO_3rd.py

# 运行SAC训练
python model/sac.py

# 运行TD3训练
python model/TD3.py
```

### 参数配置
- **训练轮数**: 50 episodes
- **学习率**: Actor 5e-6, Critic 3e-5
- **折扣因子**: 0.96
- **GAE参数**: 0.98
- **PPO裁剪**: 0.2

## 结果分析

### 输出文件
- `results/returns_ppo_YYYYMMDD_HHMMSS.csv`: 训练回报数据
- `model/cost_results/cost_data_YYYYMMDD_HHMMSS.csv`: 成本分析数据
- `model/episode_cost_results/episode_costs_YYYYMMDD_HHMMSS.csv`: 每轮成本数据

### 可视化图表
1. **SOC变化图**: EV和ESS电池状态变化
2. **电价对比图**: 分时电价与用电量关系
3. **奖励分解图**: 各奖励组成部分分析
4. **成本分析图**: 总成本和分项成本趋势

## 代码问题说明

### 关于Linter错误

项目中出现的Linter错误主要是由于不同开发环境的类型检查严格程度不同：

1. **类型转换错误** (第208行)
   ```python
   actions[name] = self.action_mapping[name][int(action_idx.item())]
   ```
   - **问题**: `action_idx.item()`返回`Number`类型，但字典索引期望`int`类型
   - **原因**: PyTorch的`.item()`方法返回的是`Number`类型，在某些类型检查器中会被识别为`float`
   - **解决方案**: 显式转换为int类型
   - **为什么PyCharm不报错**: PyCharm的类型检查器配置更宽松，能够自动推断类型转换

2. **梯度裁剪错误** (第386-388行)
   ```python
   torch.nn.utils.clip_grad_norm_(self.shared_backbone.parameters(), self.max_grad_norm)
   ```
   - **问题**: `clip_grad_norm_`函数在某些PyTorch版本中可能不被正确识别
   - **原因**: 
     - PyTorch版本差异：不同版本的PyTorch API导出方式可能不同
     - 类型检查器差异：某些linter可能无法正确识别PyTorch的动态导入
   - **解决方案**: 使用try-except处理兼容性，支持不同版本的PyTorch
   - **为什么PyCharm不报错**: PyCharm对PyTorch库有更好的支持，能够正确识别API

### 为什么PyCharm中不报错

1. **类型检查配置**: 
   - PyCharm的类型检查可能配置为更宽松的模式
   - 某些linter（如mypy）配置更严格，会报告更多潜在问题

2. **PyTorch版本支持**: 
   - PyCharm对PyTorch库有专门的支持和类型注解
   - 不同版本的PyTorch可能有不同的类型注解质量

3. **运行环境差异**: 
   - 实际运行时Python解释器能够正确处理这些类型转换
   - 静态类型检查器可能无法完全理解动态类型

4. **IDE集成**: 
   - PyCharm作为专业Python IDE，对科学计算库有更好的支持
   - 命令行linter可能缺乏对PyTorch等库的深度理解

### 代码兼容性解决方案

为了确保代码在不同环境中都能正常运行，我们采用了以下策略：

1. **显式类型转换**: 使用`int()`确保类型安全
2. **异常处理**: 使用try-except处理API兼容性问题
3. **版本检查**: 在必要时检查PyTorch版本
4. **文档说明**: 在README中详细说明可能的问题和解决方案

### 建议的开发环境配置

1. **PyCharm设置**: 
   - 启用类型检查但设置为宽松模式
   - 配置PyTorch库路径
   - 使用项目解释器

2. **命令行开发**: 
   - 使用兼容的linter配置
   - 忽略已知的PyTorch相关警告
   - 定期运行测试确保功能正常

3. **CI/CD**: 
   - 在CI环境中使用相同的PyTorch版本
   - 配置适当的linter规则
   - 运行完整的测试套件

## 性能优化建议

1. **状态归一化**: 使用在线归一化提高训练稳定性
2. **动作掩码**: 减少无效动作探索，提高学习效率
3. **多设备协调**: 考虑设备间的相互影响
4. **实时适应**: 根据用户行为模式动态调整策略

## 未来改进方向

1. **多目标优化**: 同时优化成本、舒适度和环保性
2. **用户个性化**: 学习用户偏好并个性化策略
3. **预测模型**: 集成天气和用电需求预测
4. **分布式学习**: 多家庭协同学习
5. **在线学习**: 实时适应环境变化

## 联系方式

如有问题或建议，请联系项目维护者。 